<!DOCTYPE html>
<html lang="zh-CN" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daifu Clash</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- Base Styles --- */
        :root { --bg: #f7f8fa; --text-primary: #1e293b; --text-secondary: #475569; --card-bg: #ffffff; --border-color: #e2e8f0; --hover-bg: #f1f5f9; --active-bg: #4f46e5; }
        html.dark { --bg: #0f172a; --text-primary: #e2e8f0; --text-secondary: #94a3b8; --card-bg: #1e293b; --border-color: #334155; --hover-bg: #334155; }
        body { font-family: 'Nunito', sans-serif; background-color: var(--bg); color: var(--text-secondary); -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }

        /* --- UI Components --- */
        .card { background-color: var(--card-bg); border-radius: 1rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05); transition: box-shadow 0.3s; color: var(--text-primary); }
        .card:hover { box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -2px rgb(0 0 0 / 0.05); }
        .nav-link.active { background-color: var(--active-bg); color: white; box-shadow: 0 4px 6px -1px rgb(79 70 229 / 0.2), 0 2px 4px -2px rgb(79 70 229 / 0.2); }
        .nav-link.active i, .nav-link.active svg { color: white !important; }
        .prose strong { font-weight: 700; color: var(--text-primary); } .prose ul { list-style-type: disc; padding-left: 1.5rem; } .prose li { margin-bottom: 0.5rem; } .prose p { margin-bottom: 1rem; }
        .sortable-header { cursor: pointer; user-select: none; }
        .switch-toggle:checked { background-color: #4f46e5; }
        
        /* --- Animations & Placeholders --- */
        .skeleton { background-color: var(--border-color); border-radius: 0.5rem; animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 50% { opacity: .5; } }
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* --- Toast Notification Styles --- */
        #toast-container { position: fixed; top: 1.5rem; right: 1.5rem; z-index: 1000; display: flex; flex-direction: column; gap: 0.75rem; }
        .toast { display: flex; align-items: center; padding: 1rem 1.5rem; border-radius: 0.75rem; color: white; transform: translateX(120%); opacity: 0; transition: transform 0.4s ease, opacity 0.4s ease; }
        .toast.show { transform: translateX(0); opacity: 1; }
        .toast-success { background-color: #10b981; }
        .toast-error { background-color: #ef4444; }
    </style>
</head>
<body class="text-slate-700">

<!-- Main App Container -->
<div id="app" class="h-screen w-screen overflow-hidden flex">
    <!-- Sidebar -->
    <nav id="sidebar" class="bg-[var(--card-bg)] flex flex-col z-30 transition-transform duration-300 md:translate-x-0 md:relative md:w-64 flex-shrink-0 absolute h-full w-64 -translate-x-full">
        <div class="flex items-center justify-start h-24 border-b border-[var(--border-color)] flex-shrink-0 px-6">
             <img src="https://i.miji.bid/2025/06/15/81c0339d023ffc3a6c44e51d17b7148d.png" alt="Daifu Clash Logo" class="h-12 w-12 transition-transform duration-300 hover:rotate-12">
             <span class="ml-4 text-2xl font-bold whitespace-nowrap text-[var(--text-primary)]">Daifu Clash</span>
        </div>
        <ul id="nav-links" class="flex-grow pt-4"></ul>
        <!-- API Status Indicator -->
        <div id="api-status" class="flex-shrink-0 p-6 border-t border-[var(--border-color)]">
             <div class="flex items-center text-amber-500"><i data-feather="loader" class="w-6 h-6 mr-3 animate-spin"></i><span class="font-semibold">连接中...</span></div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col overflow-hidden">
        <header class="md:hidden flex justify-between items-center h-20 bg-[var(--card-bg)] border-b border-[var(--border-color)] px-4">
            <button id="menu-btn" class="p-2"><i data-feather="menu" class="w-6 h-6 text-[var(--text-secondary)]"></i></button>
            <span id="mobile-header-title" class="text-xl font-bold text-[var(--text-primary)]"></span>
            <div class="w-8"></div>
        </header>
        <main id="main-content" class="overflow-y-auto p-4 sm:p-6 md:p-8 lg:p-10"></main>
    </div>

    <!-- Modal Container -->
    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div id="modal-content" class="bg-[var(--card-bg)] rounded-2xl shadow-xl max-w-2xl w-full max-h-[90vh] flex flex-col"></div>
    </div>
    
    <!-- Toast Notification Container -->
    <div id="toast-container"></div>
</div>

<script type="module">
    // --- INTERNATIONALIZATION (i18n) ---
    const translations = {
        'zh-CN': {
            nav: { overview: '总览', proxies: '代理', rules: '规则', connections: '连接', logs: '日志', settings: '设置' },
            overview: { title: '总览', status: '状态', version: '内核版本', sessionStats: '会话统计', totalDown: '总下载', totalUp: '总上传', realTimeSpeed: '实时速度', download: '下载', upload: '上传', modeChanged: '模式已切换至 ', coreInfo: '核心信息', activeConnections: '活动连接', proxyGroups: '代理组', rulesCount: '规则数' },
            proxies: { title: '代理选择', groups: '策略组', searchPlaceholder: '搜索节点...', testAll: '测试延迟', selectGroup: '请先选择一个策略组。', nodeDetails: '节点详情', latencyHistory: '延迟历史', noHistory: '暂无历史延迟数据。', nodeType: '节点类型', optimize: '✨ 智能优化' },
            rules: { title: '规则列表', searchPlaceholder: '搜索规则...', type: '类型', value: '值', policy: '策略组', explain: '✨ 解释规则' },
            connections: { title: '实时连接', analyze: '✨ 分析连接', searchPlaceholder: '搜索主机、规则、节点...', host: '主机', network: '网络', rule: '规则', chains: '节点', speed: '速度', traffic: '流量', actions: '操作', confirmClose: '确认操作', confirmCloseMsg: '您确定要断开此连接吗？' },
            logs: { title: '实时日志', filterBy: '过滤等级:', all: '全部', analyze: '✨ 智能分析' },
            settings: { title: '设置', apiSettings: 'API 设置', apiSettingsDesc: '配置连接到后端服务的地址。', mihomoApiUrl: 'Mihomo API 地址', latencyTestUrl: '延迟测试URL', latencyTestUrlPlaceholder: '例如: http://www.google.com/generate_204', aiProvider: 'AI 提供商', apiKey: 'API Key', baseUrl: 'API Base URL (可选)', appearance: '外观', theme: '主题', language: '语言', save: '保存设置', saved: '保存成功', saving: '保存中...', themes: { light: '明亮', dark: '暗黑' } },
            common: { connected: '已连接', disconnected: '连接失败', connecting: '连接中...', cancel: '取消', confirm: '确认' },
            analyzer: { 
                title: 'AI 分析', 
                loading: '正在请求 AI 进行分析，请稍候...', 
                error: '分析失败', 
                errorMsg: '无法连接到 AI API 或解析结果时出错。', 
                noApiKey: '需要 API Key', 
                noApiKeyMsg: '请先在“设置”页面填入您选择的 AI 提供商的 API Key。', 
                goToSettings: '前往设置', 
                noConnections: '没有活动的连接可供分析。',
                noLogs: '没有日志可供分析。',
                noProxies: '当前策略组没有可供分析的节点。',
                connectionPrompt: `你是一位网络流量分析专家。以下是来自用户计算机的活动网络连接列表。请提供一份简洁易懂的摘要，并使用 Markdown 格式化。请将连接按其用途分类（例如：系统服务、网页浏览、流媒体、社交媒体、广告/追踪器等），并明确指出任何已知的广告或追踪域名。摘要语言请使用中文。\n\n连接信息：\n`,
                logPrompt: '你是一位网络流量分析专家。以下是来自 Clash 核心的最新日志。请用简洁的语言总结这些日志，识别并高亮潜在的错误、警告或值得注意的模式，特别是识别事件之间的关联性（例如，DNS解析失败后，同一个域名的连接也失败了）。最后以 Markdown 格式化输出。摘要语言请使用中文。\n\n日志信息:\n',
                rulePrompt: '你是一位网络规则配置专家。请用简单易懂的语言解释下面这条 Clash 规则的作用。解释应包含规则类型、匹配的目标（值）以及它将采取的策略。语言请使用中文。\n\n规则:\n',
                proxyPrompt: '你是一位网络优化专家。下面是用户当前策略组中的节点列表及其性能数据（延迟历史）。请分析这些数据，提供一份优化报告。报告应包括：\n1. **总体评价**：对当前节点质量的简要总结。\n2. **最佳节点推荐**：明确指出哪个节点当前表现最好，并解释原因（例如，延迟最低且最稳定）。\n3. **问题节点识别**：指出哪些节点延迟过高（例如 > 500ms）、不稳定或不可用，并建议用户规避。\n4. **总结建议**：提供一个最终的、明确的操作建议。\n请使用 Markdown 格式化报告，语言为中文。\n\n节点数据：\n'
            }
        },
        'en': {
            nav: { overview: 'Overview', proxies: 'Proxies', rules: 'Rules', connections: 'Connections', logs: 'Logs', settings: 'Settings' },
            overview: { title: 'Overview', status: 'Status', version: 'Version', sessionStats: 'Session Stats', totalDown: 'Total Down', totalUp: 'Total Up', realTimeSpeed: 'Real-time Speed', download: 'Download', upload: 'Upload', modeChanged: 'Mode changed to ', coreInfo: 'Core Info', activeConnections: 'Active Connections', proxyGroups: 'Proxy Groups', rulesCount: 'Rules Count' },
            proxies: { title: 'Proxy Selection', groups: 'Groups', searchPlaceholder: 'Search nodes...', testAll: 'Test Latency', selectGroup: 'Please select a group first.', nodeDetails: 'Node Details', latencyHistory: 'Latency History', noHistory: 'No latency history available.', nodeType: 'Node Type', optimize: '✨ Smart Optimize' },
            rules: { title: 'Rules', searchPlaceholder: 'Search rules...', type: 'Type', value: 'Value', policy: 'Policy', explain: '✨ Explain Rule' },
            connections: { title: 'Connections', analyze: '✨ Analyze Connections', searchPlaceholder: 'Search host, rule, chains...', host: 'Host', network: 'Network', rule: 'Rule', chains: 'Chains', speed: 'Speed', traffic: 'Traffic', actions: 'Actions', confirmClose: 'Confirm Action', confirmCloseMsg: 'Are you sure you want to close this connection?' },
            logs: { title: 'Logs', filterBy: 'Filter by level:', all: 'All', analyze: '✨ Analyze Logs' },
            settings: { title: 'Settings', apiSettings: 'API Settings', apiSettingsDesc: 'Configure addresses for backend services.', mihomoApiUrl: 'Mihomo API URL', latencyTestUrl: 'Latency Test URL', latencyTestUrlPlaceholder: 'e.g. http://www.google.com/generate_204', aiProvider: 'AI Provider', apiKey: 'API Key', baseUrl: 'API Base URL (Optional)', appearance: 'Appearance', theme: 'Theme', language: 'Language', save: 'Save Settings', saved: 'Saved!', saving: 'Saving...', themes: { light: 'Light', dark: 'Dark' } },
            common: { connected: 'Connected', disconnected: 'Disconnected', connecting: 'Connecting...', cancel: 'Cancel', confirm: 'Confirm' },
            analyzer: { 
                title: 'AI Analysis', 
                loading: 'Requesting analysis from AI, please wait...', 
                error: 'Analysis Failed', 
                errorMsg: 'Failed to connect to AI API or parse the result.', 
                noApiKey: 'API Key Required', 
                noApiKeyMsg: 'Please enter the API Key for your chosen AI provider in the Settings page.', 
                goToSettings: 'Go to Settings', 
                noConnections: 'No active connections to analyze.',
                noLogs: 'No logs to analyze.',
                noProxies: 'No proxies in the current group to analyze.',
                connectionPrompt: `You are a network traffic analyst. Below is a list of active network connections from a user's computer. Please provide a brief, easy-to-understand summary, formatted in Markdown. Categorize the connections by their purpose (e.g., System Services, Web Browsing, Streaming, Social Media, Ads/Trackers) and point out any domains known for advertising or tracking. The summary should be in English.\n\nConnections:\n`,
                logPrompt: `You are a network traffic analyst. Below are the latest logs from a Clash core. Please summarize them concisely, identify and highlight potential errors, warnings, or noteworthy patterns, especially correlated events (e.g., a DNS failure followed by a connection timeout for the same host). Finally, format the output in Markdown. The summary should be in English.\n\nLogs:\n`,
                rulePrompt: `You are a network rule configuration expert. Please explain what the following Clash rule does in simple, easy-to-understand language. The explanation should include the rule type, its matching target (value), and the policy it will apply. The language should be in English.\n\nRule:\n`,
                proxyPrompt: `You are a network optimization expert. Below is a list of nodes from the user's current policy group, along with their performance data (latency history). Please analyze this data and provide an optimization report. The report should include:\n1. **Overall Assessment**: A brief summary of the current node quality.\n2. **Best Node Recommendation**: Clearly state which node is performing best and why (e.g., lowest and most stable latency).\n3. **Problematic Nodes**: Point out any nodes with high latency (e.g., >500ms), instability, or unavailability, and advise the user to avoid them.\n4. **Summary & Suggestion**: Provide a final, clear recommendation.\nPlease format the report in Markdown, and the language should be English.\n\nNode Data:\n`
            }
        }
    };
    const t = (key) => {
        const keys = key.split('.');
        let result = translations[state.language] || translations['en'];
        for (const k of keys) { result = result?.[k]; if (!result) return key; }
        return result;
    };

    // --- APP STATE & CONFIG ---
    const state = {
        apiBaseUrl: localStorage.getItem('mihomoApiUrl') || 'http://127.0.0.1:9090',
        latencyTestUrl: localStorage.getItem('latencyTestUrl') || 'http://www.google.com/generate_204',
        ai: JSON.parse(localStorage.getItem('aiConfig')) || { provider: 'gemini', apiKey: '', baseUrl: '', model: '' },
        theme: localStorage.getItem('theme') || 'light',
        language: localStorage.getItem('language') || (navigator.language.startsWith('zh') ? 'zh-CN' : 'en'),
        currentPage: '', traffic: { up: 0, down: 0 }, trafficHistory: { up: Array(60).fill(0), down: Array(60).fill(0) }, proxies: {}, rules: [], configs: {}, version: '', selectedProxyGroup: null, connections: { list: [], map: {}, sort: { key: 'id', order: 'asc' }, sessionTotal: { up: 0, down: 0 } }, logs: { list: [], filterLevel: 'all' },
    };
    let trafficChart;
    let sockets = {};

    // --- TEMPLATES ---
    const templates = {
        overview: `<h1 class="text-3xl md:text-4xl font-bold text-[var(--text-primary)] mb-8">${t('overview.title')}</h1><div class="grid grid-cols-1 lg:grid-cols-3 gap-6 md:gap-8"><div class="lg:col-span-2 space-y-8"><div class="card p-6"><h2 class="text-lg font-bold text-[var(--text-secondary)] mb-2">${t('overview.realTimeSpeed')}</h2><div class="flex flex-col sm:flex-row items-start sm:items-end gap-6 sm:gap-12"><div><div class="flex items-center"><i data-feather="arrow-down" class="w-4 h-4 mr-2 text-emerald-500"></i>${t('overview.download')}</div><div id="traffic-down" class="traffic-value text-3xl font-bold text-[var(--text-primary)] skeleton w-40 h-9"></div></div><div><div class="flex items-center"><i data-feather="arrow-up" class="w-4 h-4 mr-2 text-sky-500"></i>${t('overview.upload')}</div><div id="traffic-up" class="traffic-value text-3xl font-bold text-[var(--text-primary)] skeleton w-40 h-9"></div></div></div><div class="h-48 md:h-64 mt-4"><canvas id="traffic-chart"></canvas></div></div></div><div class="lg:col-span-1 space-y-8"><div class="card p-6"><h2 class="text-lg font-bold text-[var(--text-secondary)] mb-4">${t('overview.coreInfo')}</h2><div class="space-y-4"><div class="flex justify-between items-center"><span class="font-semibold">${t('overview.activeConnections')}</span><span id="active-connections-count" class="font-bold text-lg text-[var(--text-primary)] skeleton w-12 h-6"></span></div><div class="flex justify-between items-center"><span class="font-semibold">${t('overview.proxyGroups')}</span><span id="proxy-groups-count" class="font-bold text-lg text-[var(--text-primary)] skeleton w-12 h-6"></span></div><div class="flex justify-between items-center"><span class="font-semibold">${t('overview.rulesCount')}</span><span id="rules-count" class="font-bold text-lg text-[var(--text-primary)] skeleton w-12 h-6"></span></div><div class="flex justify-between items-center pt-2 border-t border-[var(--border-color)] mt-4"><span class="font-semibold">${t('overview.version')}</span><span id="version-text" class="info-value skeleton w-16 h-6"></span></div></div></div><div class="card p-6"><h2 class="text-lg font-bold text-[var(--text-secondary)] mb-4">${t('overview.sessionStats')}</h2><div class="space-y-3"><div class="flex justify-between items-center"><span class="font-semibold flex items-center"><i data-feather="arrow-down" class="w-4 h-4 mr-2 text-emerald-500"></i>${t('overview.totalDown')}</span><span id="total-down" class="font-mono text-slate-600 dark:text-slate-400">0 B</span></div><div class="flex justify-between items-center"><span class="font-semibold flex items-center"><i data-feather="arrow-up" class="w-4 h-4 mr-2 text-sky-500"></i>${t('overview.totalUp')}</span><span id="total-up" class="font-mono text-slate-600 dark:text-slate-400">0 B</span></div></div></div></div></div>`,
        proxies: `<h1 class="text-3xl md:text-4xl font-bold text-[var(--text-primary)] mb-8">${t('proxies.title')}</h1><div class="flex flex-col md:flex-row gap-8 h-[calc(100vh-200px)] md:h-[calc(100vh-150px)]"><div class="w-full md:w-1/3 lg:w-1/4 card p-4 flex flex-col"><div class="flex-shrink-0 p-2 mb-2"><h2 class="text-xl font-bold">${t('proxies.groups')}</h2></div><ul id="proxy-groups-list" class="space-y-1 overflow-y-auto flex-grow pr-2"><li class="skeleton h-12 w-full"></li></ul></div><div class="flex-grow card p-4 flex flex-col"><div id="nodes-header" class="flex flex-col sm:flex-row justify-between items-start sm:items-center p-2 mb-2 flex-shrink-0 gap-4"><h2 class="text-xl font-bold skeleton h-8 w-48"></h2><div class="flex items-center gap-2"><input type="text" id="node-search-input" placeholder="${t('proxies.searchPlaceholder')}" class="bg-[var(--hover-bg)] border-none text-sm rounded-lg p-2 focus:ring-2 focus:ring-indigo-500 w-full sm:w-auto"><button id="optimize-proxies-btn" class="p-2 rounded-full hover:bg-[var(--hover-bg)]" title="${t('proxies.optimize')}"><i data-feather="wand" class="w-5 h-5 text-indigo-500"></i></button><button id="test-all-latency-btn" class="p-2 rounded-full hover:bg-[var(--hover-bg)] disabled:opacity-50" title="${t('proxies.testAll')}"><i data-feather="zap" class="w-5 h-5"></i></button></div></div><div id="nodes-container" class="proxies-container grid grid-cols-1 xl:grid-cols-2 2xl:grid-cols-3 gap-4 overflow-y-auto flex-grow p-2"><div class="skeleton h-20 w-full"></div></div></div></div>`,
        rules: `<div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-8 gap-4"><h1 class="text-3xl md:text-4xl font-bold text-[var(--text-primary)]">${t('rules.title')}</h1><input type="text" id="rule-search-input" placeholder="${t('rules.searchPlaceholder')}" class="bg-[var(--card-bg)] border border-[var(--border-color)] text-sm rounded-lg p-2 focus:ring-2 focus:ring-indigo-500 w-full sm:w-64"></div><div class="card p-4 h-[calc(100vh-200px)] md:h-[calc(100vh-150px)] overflow-y-auto"><table class="w-full text-left"><thead class="sticky top-0 bg-[var(--card-bg)] z-10"><tr class="border-b-2 border-[var(--border-color)]"><th class="p-4 text-sm font-bold text-[var(--text-secondary)]">${t('rules.type')}</th><th class="p-4 text-sm font-bold text-[var(--text-secondary)]">${t('rules.value')}</th><th class="p-4 text-sm font-bold text-[var(--text-secondary)]">${t('rules.policy')}</th><th class="p-4 text-sm font-bold text-[var(--text-secondary)] text-right">${t('connections.actions')}</th></tr></thead><tbody id="rules-tbody"></tbody></table></div>`,
        connections: `<div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-8 gap-4"><h1 class="text-3xl md:text-4xl font-bold text-[var(--text-primary)]">${t('connections.title')}</h1><div class="flex items-center gap-4"><input type="text" id="connection-search-input" placeholder="${t('connections.searchPlaceholder')}" class="bg-[var(--card-bg)] border border-[var(--border-color)] text-sm rounded-lg p-2 focus:ring-2 focus:ring-indigo-500 w-full sm:w-64"><button id="analyze-connections-btn" class="flex items-center gap-2 text-white bg-indigo-600 hover:bg-indigo-700 font-semibold rounded-lg text-sm px-5 py-2.5 text-center">${t('connections.analyze')}</button></div></div><div id="connections-container" class="h-[calc(100vh-200px)] md:h-[calc(100vh-150px)] overflow-y-auto"></div>`,
        logs: `<div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-8 gap-4"><h1 class="text-3xl md:text-4xl font-bold text-[var(--text-primary)]">${t('logs.title')}</h1><div class="flex items-center gap-4"><div class="flex items-center gap-2 text-sm"><span class="font-semibold">${t('logs.filterBy')}</span><div id="log-filter-buttons" class="flex items-center space-x-1 p-1 bg-[var(--hover-bg)] rounded-full font-semibold"></div></div><button id="analyze-logs-btn" class="flex items-center gap-2 text-white bg-indigo-600 hover:bg-indigo-700 font-semibold rounded-lg text-sm px-5 py-2.5 text-center">${t('logs.analyze')}</button></div></div><div id="logs-container" class="card p-4 h-[calc(100vh-230px)] md:h-[calc(100vh-180px)] overflow-y-auto bg-gray-900 text-white font-mono text-sm"></div>`,
        settings: `<h1 class="text-3xl md:text-4xl font-bold text-[var(--text-primary)] mb-8">${t('settings.title')}</h1><div class="space-y-8 max-w-2xl"><div class="card p-8"><h2 class="text-xl font-bold mb-1">${t('settings.apiSettings')}</h2><p class="text-[var(--text-secondary)] mb-6">${t('settings.apiSettingsDesc')}</p><div class="space-y-4"><div><label for="mihomo-api-url" class="block mb-2 font-semibold">${t('settings.mihomoApiUrl')}</label><input type="text" id="mihomo-api-url" class="w-full p-2.5 bg-[var(--hover-bg)] border-none rounded-lg focus:ring-2 focus:ring-indigo-500"></div><div><label for="latency-test-url" class="block mb-2 font-semibold">${t('settings.latencyTestUrl')}</label><input type="text" id="latency-test-url" placeholder="${t('settings.latencyTestUrlPlaceholder')}" class="w-full p-2.5 bg-[var(--hover-bg)] border-none rounded-lg focus:ring-2 focus:ring-indigo-500"></div><hr class="border-[var(--border-color)] my-2 !mt-6"><h3 class="font-bold text-lg pt-2">AI 分析设置</h3><div><label for="ai-provider" class="block mb-2 font-semibold">${t('settings.aiProvider')}</label><select id="ai-provider" class="w-full p-2.5 bg-[var(--hover-bg)] border-none rounded-lg focus:ring-2 focus:ring-indigo-500"><option value="gemini">Gemini</option><option value="openai">OpenAI</option><option value="deepseek">DeepSeek</option><option value="grok">Grok</option></select></div><div id="ai-api-key-container"></div><div id="ai-base-url-container" class="hidden"></div><div id="ai-model-container" class="hidden"></div></div></div><div class="card p-8"><h2 class="text-xl font-bold mb-4">${t('settings.appearance')}</h2><div class="space-y-6"> <div class="flex justify-between items-center"><span class="font-semibold">${t('settings.theme')}</span><div class="flex items-center space-x-1 p-1 bg-[var(--hover-bg)] rounded-full text-sm font-semibold"> <button id="theme-light-btn" class="px-3 py-1 rounded-full flex items-center gap-2"><i data-feather="sun"></i> ${t('settings.themes.light')}</button><button id="theme-dark-btn" class="px-3 py-1 rounded-full flex items-center gap-2"><i data-feather="moon"></i> ${t('settings.themes.dark')}</button></div></div><div class="flex justify-between items-center"><span class="font-semibold">${t('settings.language')}</span><select id="language-selector" class="p-2 bg-[var(--hover-bg)] border-none rounded-lg focus:ring-2 focus:ring-indigo-500"><option value="zh-CN">简体中文</option><option value="en">English</option></select></div></div></div><div class="flex justify-end"><button id="save-settings-btn" class="flex items-center justify-center w-36 text-white bg-indigo-600 hover:bg-indigo-700 font-semibold rounded-lg text-sm px-6 py-3 text-center">${t('settings.save')}</button></div></div>`
    };

    // --- App Core ---
    const App = {
        init() { this.setLanguage(state.language); this.setTheme(state.theme); this.router(); window.addEventListener('hashchange', () => this.router()); this.connectAllSockets(); this.fetchInitialData(); this.setupGlobalEventListeners(); feather.replace(); },
        api: async (method, endpoint, body) => { try { const opts = { method, headers: { 'Content-Type': 'application/json' } }; if (body) opts.body = JSON.stringify(body); const res = await fetch(`${state.apiBaseUrl}${endpoint}`, opts); if (method === 'GET') { if (!res.ok) throw new Error(`HTTP ${res.status}`); return await res.json(); } return res.status === 204; } catch (e) { console.error(`${method} ${endpoint} failed:`, e); App.updateApiStatus(false); throw e; } },
        connectSocket(name, path, onMessage) { if (sockets[name]) sockets[name].close(); const url = state.apiBaseUrl.replace('http', 'ws') + path; const ws = new WebSocket(url); sockets[name] = ws; ws.onmessage = onMessage; ws.onopen = () => this.updateApiStatus(true); ws.onerror = () => this.updateApiStatus(false); ws.onclose = () => { this.updateApiStatus(false); setTimeout(() => this.connectSocket(name, path, onMessage), 5000); }; },
        connectAllSockets() {
            this.connectSocket('traffic', '/traffic', (event) => { state.traffic = JSON.parse(event.data); this.updateTrafficHistory(); if (state.currentPage === 'overview') this.updateOverviewUI(); });
            this.connectSocket('connections', '/connections', (event) => { const data = JSON.parse(event.data); const newConns = data.connections || []; let up = 0, down = 0; const newMap = {}; newConns.forEach(conn => { newMap[conn.id] = conn; const old = state.connections.map[conn.id]; old ? (up += (conn.upload - old.upload), down += (conn.download - old.download)) : (up += conn.upload, down += conn.download); }); state.connections.sessionTotal.up += up > 0 ? up : 0; state.connections.sessionTotal.down += down > 0 ? down : 0; state.connections.list = newConns; state.connections.map = newMap; if (state.currentPage === 'connections') this.renderConnectionsList(); if (state.currentPage === 'overview') this.updateOverviewUI(); });
            this.connectSocket('logs', '/logs', (event) => { const log = JSON.parse(event.data); state.logs.list.unshift(log); if (state.logs.list.length > 300) state.logs.list.pop(); if (state.currentPage === 'logs') this.renderLogsList(); });
        },
        async fetchInitialData() { try { const [configs, proxies, version, rules] = await Promise.all([this.api('GET', '/configs'), this.api('GET', '/proxies'), this.api('GET', '/version'), this.api('GET', '/rules')]); if (configs) state.configs = configs; if (proxies) state.proxies = proxies.proxies; if (version) state.version = version.version; if (rules) state.rules = rules.rules; this.render(); } catch(e) { console.error("Failed to fetch initial data", e); this.updateApiStatus(false); } },
        render() { const path = window.location.hash.slice(2) || 'overview'; state.currentPage = path; document.getElementById('main-content').innerHTML = templates[path] || templates.overview; this[`render_${path}`](); feather.replace(); this.updateNav(); document.getElementById('mobile-header-title').textContent = t(`nav.${path}`); },
        formatBytes: (bytes, perSecond = false) => { if (!bytes || bytes === 0) return perSecond ? '0 B/s' : '0 B'; const k = 1024, sizes = perSecond ? ['B/s', 'KB/s', 'MB/s', 'GB/s'] : ['B', 'KB', 'MB', 'GB'], i = Math.floor(Math.log(bytes) / Math.log(k)); return `${(bytes / Math.pow(k, i)).toFixed(i === 0 ? 0 : 1)} ${sizes[i]}`; },
        showToast(message, type = 'success', duration = 3000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `<i data-feather="${type === 'success' ? 'check-circle' : 'alert-circle'}" class="w-5 h-5 mr-3"></i><span>${message}</span>`;
            container.appendChild(toast);
            feather.replace();
            setTimeout(() => { toast.classList.add('show'); }, 10);
            setTimeout(() => { toast.classList.remove('show'); toast.addEventListener('transitionend', () => toast.remove()); }, duration);
        },
        
        // --- Page Renderers & Logic ---
        render_overview() { this.updateOverviewUI(); this.createTrafficChart(); },
        updateOverviewUI() { ['traffic-down', 'traffic-up', 'version-text', 'active-connections-count', 'proxy-groups-count', 'rules-count'].forEach(id => document.getElementById(id)?.classList.remove('skeleton')); document.getElementById('traffic-down').textContent = this.formatBytes(state.traffic.down, true); document.getElementById('traffic-up').textContent = this.formatBytes(state.traffic.up, true); document.getElementById('total-down').textContent = this.formatBytes(state.connections.sessionTotal.down); document.getElementById('total-up').textContent = this.formatBytes(state.connections.sessionTotal.up); document.getElementById('version-text').textContent = state.version; document.getElementById('active-connections-count').textContent = state.connections.list.length; document.getElementById('proxy-groups-count').textContent = Object.values(state.proxies).filter(p => p.all).length; document.getElementById('rules-count').textContent = state.rules.length; },
        
        render_proxies() { const ordered = state.configs['proxy-groups']?.map(g => g.name) || Object.keys(state.proxies).filter(k => state.proxies[k].all); const groups = ordered.map(name => state.proxies[name]).filter(Boolean); if (!state.selectedProxyGroup && groups.length > 0) { state.selectedProxyGroup = groups[0].name; } this.renderProxyGroups(groups); this.renderNodesForSelectedGroup(); document.getElementById('optimize-proxies-btn').onclick = () => this.analyzeProxiesWithAI(); },
        renderProxyGroups(groups) { const list = document.getElementById('proxy-groups-list'); list.innerHTML = groups.map(g => `<li data-group-name="${g.name}" class="group-item p-3 rounded-lg cursor-pointer transition-colors ${state.selectedProxyGroup === g.name ? 'bg-indigo-100 text-indigo-700 font-bold dark:bg-indigo-900/50 dark:text-indigo-300' : 'hover:bg-[var(--hover-bg)]'}"><p>${g.name}</p><p class="text-sm opacity-60 truncate">${g.now || 'N/A'}</p></li>`).join(''); list.querySelectorAll('.group-item').forEach(item => item.addEventListener('click', (e) => { state.selectedProxyGroup = e.currentTarget.dataset.groupName; this.render_proxies(); })); },
        renderNodesForSelectedGroup(searchTerm = '') { const group = Object.values(state.proxies).find(p => p.name === state.selectedProxyGroup); const container = document.getElementById('nodes-container'); const header = document.getElementById('nodes-header').querySelector('h2'); if (!group) { container.innerHTML = `<p class="m-4">${t('proxies.selectGroup')}</p>`; return; } header.textContent = group.name; header.classList.remove('skeleton'); const nodes = group.all.filter(name => name.toLowerCase().includes(searchTerm.toLowerCase())); container.innerHTML = nodes.map(name => { const node = state.proxies[name], sel = group.now === name; const lat = node.history?.[node.history.length-1]?.delay; const l_color = !lat ? 'bg-slate-400' : lat > 500 ? 'bg-red-500' : lat > 200 ? 'bg-amber-500' : 'bg-green-500'; return `<div data-node-name="${name}" class="node-card p-4 border border-[var(--border-color)] rounded-xl flex items-center justify-between cursor-pointer transition-all ${sel ? 'border-indigo-500 ring-2 ring-indigo-200 dark:ring-indigo-700' : 'hover:border-indigo-400'}"><div><p class="font-semibold">${name}</p><span class="text-xs px-2 py-0.5 bg-[var(--hover-bg)] text-[var(--text-secondary)] rounded-full">${node.type}</span></div><div class="flex items-center space-x-3"><span class="flex items-center text-sm font-semibold"><span class="w-2 h-2 rounded-full mr-2 ${l_color}"></span>${lat !== undefined ? lat+'ms' : 'N/A'}</span><button data-node-name="${name}" class="proxy-details-btn p-1 rounded-full text-[var(--text-secondary)] hover:bg-[var(--hover-bg)]"><i data-feather="info" class="w-4 h-4"></i></button></div></div>`; }).join(''); feather.replace(); const nodeCards = container.querySelectorAll('.node-card'); nodeCards.forEach(card => card.addEventListener('click', async (e) => { if (e.target.closest('.proxy-details-btn')) return; await this.api('PUT', `/proxies/${encodeURIComponent(state.selectedProxyGroup)}`, { name: e.currentTarget.dataset.nodeName }); const data = await this.api('GET', '/proxies'); if (data) { state.proxies = data.proxies; this.render_proxies(); } })); nodeCards.forEach(card => card.querySelector('.proxy-details-btn').addEventListener('click', (e) => { e.stopPropagation(); this.showProxyDetails(e.currentTarget.dataset.nodeName); })); document.getElementById('node-search-input').oninput = (e) => this.renderNodesForSelectedGroup(e.target.value); document.getElementById('test-all-latency-btn').onclick = async (e) => { const btn = e.currentTarget, icon = btn.querySelector('svg'); if (!icon) return; icon.classList.add('animate-spin'); btn.disabled = true; const g = Object.values(state.proxies).find(p => p.name === state.selectedProxyGroup); if (g?.all) await Promise.all(g.all.map(async name => { try { const l = await this.api('GET', `/proxies/${encodeURIComponent(name)}/delay?timeout=2000&url=${state.latencyTestUrl}`); const n = state.proxies[name]; if (n && l && typeof l.delay === 'number') { n.history = n.history || []; n.history.push({ time: new Date().toISOString(), delay: l.delay }); } } catch(err) { console.error(`Latency test for ${name} failed`, err); } })); this.renderNodesForSelectedGroup(document.getElementById('node-search-input').value); icon.classList.remove('animate-spin'); btn.disabled = false; }; },
        
        render_rules() { document.getElementById('rule-search-input').oninput = (e) => this.renderRulesList(e.target.value); this.renderRulesList(); },
        renderRulesList(searchTerm = '') { const tbody = document.getElementById('rules-tbody'); const rules = state.rules.filter(r => `${r.type}${r.payload}${r.proxy}`.toLowerCase().includes(searchTerm.toLowerCase())); tbody.innerHTML = rules.map(rule => `<tr class="border-b border-[var(--border-color)]"> <td class="p-4"><span class="px-2 py-1 bg-[var(--hover-bg)] text-xs font-bold rounded-full">${rule.type}</span></td><td class="p-4 font-mono">${rule.payload}</td><td class="p-4 font-semibold">${rule.proxy}</td><td class="p-4 text-right"><button title="${t('rules.explain')}" data-rule-type="${rule.type}" data-rule-payload="${rule.payload}" data-rule-proxy="${rule.proxy}" class="explain-rule-btn p-2 rounded-full hover:bg-[var(--hover-bg)]"><i data-feather="help-circle" class="w-5 h-5 text-indigo-500"></i></button></td></tr>`).join(''); feather.replace(); document.querySelectorAll('.explain-rule-btn').forEach(btn => btn.onclick = (e) => this.explainRuleWithAI(e.currentTarget.dataset.ruleType, e.currentTarget.dataset.rulePayload, e.currentTarget.dataset.ruleProxy));},
        
        render_connections() { this.renderConnectionsList(); document.getElementById('analyze-connections-btn').onclick = () => this.analyzeConnectionsWithAI(); document.getElementById('connection-search-input').oninput = () => this.renderConnectionsList(); },
        sortConnections(key) { const { sort } = state.connections; sort.key === key ? sort.order = (sort.order === 'asc' ? 'desc' : 'asc') : (sort.key = key, sort.order = 'desc'); this.renderConnectionsList(); },
        renderConnectionsList() { const container = document.getElementById('connections-container'); if(!container) return; const { list, sort } = state.connections; const searchTerm = document.getElementById('connection-search-input')?.value.toLowerCase() || ''; const filtered = list.filter(c => c && c.metadata && (`${c.metadata.host || c.metadata.destinationIP} ${c.rule || ''} ${c.chains?.join(' ')}`).toLowerCase().includes(searchTerm) ); const sorted = [...filtered].sort((a, b) => { let valA = 0, valB = 0; if (sort.key === 'speed') { valA = (a.speed?.down ?? 0) + (a.speed?.up ?? 0); valB = (b.speed?.down ?? 0) + (b.speed?.up ?? 0); } else { valA = (a.download ?? 0) + (a.upload ?? 0); valB = (b.download ?? 0) + (b.upload ?? 0); } return sort.order === 'asc' ? valA - valB : valB - valA; }); container.innerHTML = `<div class="md:hidden space-y-4">${sorted.map(c => `<div class="card p-4 space-y-3 text-sm"><div class="flex justify-between items-start"><div><p class="font-bold break-all">${c.metadata.host || c.metadata.destinationIP || 'N/A'}</p><p class="text-xs text-[var(--text-secondary)]">${c.chains?.join(' -> ') || 'N/A'}</p></div><button data-conn-id="${c.id}" class="close-conn-btn p-2 rounded-full -mr-2 -mt-2"><i data-feather="x" class="w-4 h-4 text-red-500"></i></button></div><div class="flex justify-between font-mono text-xs border-t border-[var(--border-color)] pt-3"><div class="space-y-1"><div class="flex items-center text-emerald-500"><i data-feather="arrow-down" class="w-3.5 h-3.5 mr-1"></i>${this.formatBytes(c.speed?.down || 0, true)}</div><div class="flex items-center text-sky-500"><i data-feather="arrow-up" class="w-3.5 h-3.5 mr-1"></i>${this.formatBytes(c.speed?.up || 0, true)}</div></div><div class="space-y-1 text-right"><div class="text-emerald-500">${this.formatBytes(c.download || 0)}</div><div class="text-sky-500">${this.formatBytes(c.upload || 0)}</div></div></div></div>`).join('')}</div><table class="w-full text-left hidden md:table"><thead class="sticky top-0 bg-[var(--card-bg)] z-10"><tr class="border-b-2 border-[var(--border-color)]"><th class="p-4 text-sm font-bold text-[var(--text-secondary)]">${t('connections.host')}</th><th class="p-4 text-sm font-bold text-[var(--text-secondary)]">${t('connections.rule')}</th><th data-sort="speed" class="sortable-header p-4 text-sm font-bold text-[var(--text-secondary)] text-right">${t('connections.speed')}</th><th data-sort="traffic" class="sortable-header p-4 text-sm font-bold text-[var(--text-secondary)] text-right">${t('connections.traffic')}</th><th class="p-4 text-sm font-bold text-[var(--text-secondary)] text-right">${t('connections.actions')}</th></tr></thead><tbody>${sorted.map(c => `<tr class="border-b border-[var(--border-color)] text-sm"><td class="p-4 truncate" style="max-width: 200px;"><p class="font-semibold">${c.metadata.host || c.metadata.destinationIP || 'N/A'}</p><p class="text-xs text-[var(--text-secondary)]">${c.chains?.join(' -> ') || 'N/A'}</p></td><td class="p-4 truncate"><p>${c.rule || 'N/A'}</p><p class="text-xs text-[var(--text-secondary)]">${c.metadata.network?.toUpperCase() || 'N/A'}</p></td><td class="p-4 text-right font-mono"><div class="flex items-center justify-end text-emerald-500"><i data-feather="arrow-down" class="w-3.5 h-3.5 mr-1"></i>${this.formatBytes(c.speed?.down || 0, true)}</div><div class="flex items-center justify-end text-sky-500"><i data-feather="arrow-up" class="w-3.5 h-3.5 mr-1"></i>${this.formatBytes(c.speed?.up || 0, true)}</div></td><td class="p-4 text-right font-mono"><div class="text-emerald-500">${this.formatBytes(c.download || 0)}</div><div class="text-sky-500">${this.formatBytes(c.upload || 0)}</div></td><td class="p-4 text-right"><button data-conn-id="${c.id}" class="close-conn-btn p-2 rounded-full hover:bg-[var(--hover-bg)]"><i data-feather="x" class="w-4 h-4 text-red-500"></i></button></td></tr>`).join('')}</tbody></table>`; feather.replace(); container.querySelectorAll('.close-conn-btn').forEach(btn => btn.onclick = (e) => this.confirmCloseConnection(e.currentTarget.dataset.connId)); container.querySelectorAll('.sortable-header').forEach(h => h.onclick = (e) => this.sortConnections(e.currentTarget.dataset.sort)); },
        
        render_logs() { this.renderLogFilterButtons(); this.renderLogsList(); document.getElementById('analyze-logs-btn').onclick = () => this.analyzeLogsWithAI(); },
        renderLogFilterButtons() { const container = document.getElementById('log-filter-buttons'); if (!container) return; const levels = ['all', 'info', 'warning', 'error', 'debug']; container.innerHTML = levels.map(level => `<button data-level="${level}" class="log-filter-btn px-3 py-1 rounded-full capitalize">${t('logs.'+level) || level}</button>`).join(''); container.querySelectorAll('.log-filter-btn').forEach(btn => { const level = btn.dataset.level; btn.classList.toggle('bg-indigo-600', level === state.logs.filterLevel); btn.classList.toggle('text-white', level === state.logs.filterLevel); btn.onclick = () => { state.logs.filterLevel = level; this.renderLogsList(); this.renderLogFilterButtons(); }; }); },
        renderLogsList() { const container = document.getElementById('logs-container'); if (!container) return; const { list, filterLevel } = state.logs; const logColor = { info: 'text-sky-400', warning: 'text-amber-400', error: 'text-red-400', debug: 'text-slate-400'}; const filtered = filterLevel === 'all' ? list : list.filter(log => log.type === filterLevel); container.innerHTML = filtered.map(log => `<div><span class="${logColor[log.type] || 'text-slate-400'}">[${log.type.toUpperCase()}]</span><span class="ml-4 text-slate-300">${log.payload}</span></div>`).join(''); },
        
        render_settings() { document.getElementById('mihomo-api-url').value = state.apiBaseUrl; document.getElementById('latency-test-url').value = state.latencyTestUrl; const providerSelect = document.getElementById('ai-provider'); providerSelect.value = state.ai.provider; this.renderAiProviderFields(); providerSelect.onchange = () => this.renderAiProviderFields(); document.getElementById('language-selector').value = state.language; this.updateThemeButtons(); document.getElementById('theme-light-btn').onclick = () => this.setTheme('light'); document.getElementById('theme-dark-btn').onclick = () => this.setTheme('dark'); document.getElementById('save-settings-btn').onclick = () => this.saveSettings(); document.getElementById('language-selector').onchange = (e) => this.setLanguage(e.target.value); },
        renderAiProviderFields() { const provider = document.getElementById('ai-provider').value; const keyContainer = document.getElementById('ai-api-key-container'); const urlContainer = document.getElementById('ai-base-url-container'); const modelContainer = document.getElementById('ai-model-container'); keyContainer.innerHTML = `<label for="ai-api-key" class="block mb-2 font-semibold">${t('settings.apiKey')}</label><input type="password" id="ai-api-key" class="w-full p-2.5 bg-[var(--hover-bg)] border-none rounded-lg" value="${state.ai.apiKey}">`; urlContainer.innerHTML = `<label for="ai-base-url" class="block mb-2 font-semibold">${t('settings.baseUrl')}</label><input type="text" id="ai-base-url" class="w-full p-2.5 bg-[var(--hover-bg)] border-none rounded-lg" value="${state.ai.baseUrl}" placeholder="e.g. https://api.openai.com/v1">`; modelContainer.innerHTML = `<label for="ai-model" class="block mb-2 font-semibold">Model</label><input type="text" id="ai-model" class="w-full p-2.5 bg-[var(--hover-bg)] border-none rounded-lg" value="${state.ai.model}" placeholder="e.g. gpt-4-turbo">`; if (provider === 'gemini') { urlContainer.classList.add('hidden'); modelContainer.classList.add('hidden'); } else { urlContainer.classList.remove('hidden'); modelContainer.classList.remove('hidden'); } },
        saveSettings() { const btn = document.getElementById('save-settings-btn'); state.apiBaseUrl = document.getElementById('mihomo-api-url').value; state.latencyTestUrl = document.getElementById('latency-test-url').value; state.ai.provider = document.getElementById('ai-provider').value; state.ai.apiKey = document.getElementById('ai-api-key').value; state.ai.baseUrl = document.getElementById('ai-base-url')?.value || ''; state.ai.model = document.getElementById('ai-model')?.value || ''; localStorage.setItem('mihomoApiUrl', state.apiBaseUrl); localStorage.setItem('latencyTestUrl', state.latencyTestUrl); localStorage.setItem('aiConfig', JSON.stringify(state.ai)); this.showToast(t('settings.saved')); btn.disabled = true; this.connectAllSockets(); this.fetchInitialData(); setTimeout(() => { btn.disabled = false; }, 2000); },
        
        // --- Modals & AI Helpers ---
        showModal(title, content, actions = '') { const modalContainer = document.getElementById('modal-container'), modalContent = document.getElementById('modal-content'); modalContent.innerHTML = `<div class="flex-shrink-0 flex justify-between items-center p-6 border-b border-[var(--border-color)]"><h2 class="text-2xl font-bold">${title}</h2><button id="modal-close-btn" class="p-1 rounded-full text-[var(--text-secondary)] hover:bg-[var(--hover-bg)]"><i data-feather="x" class="w-6 h-6"></i></button></div><div class="p-6 overflow-y-auto prose max-w-none text-[var(--text-secondary)]">${content}</div>${actions ? `<div class="flex-shrink-0 p-4 bg-[var(--hover-bg)] dark:bg-slate-800 rounded-b-2xl text-right">${actions}</div>` : ''}`; modalContainer.classList.replace('hidden', 'flex'); feather.replace(); document.getElementById('modal-close-btn').onclick = () => this.hideModal(); },
        hideModal() { document.getElementById('modal-container').classList.replace('flex', 'hidden'); },
        showProxyDetails(nodeName) { const node = state.proxies[nodeName]; if (!node) return; const historyHtml = node.history && node.history.length > 0 ? `<h3>${t('proxies.latencyHistory')}</h3><ul class="list-disc pl-5 text-sm">` + [...node.history].reverse().map(h => `<li><span class="font-mono">${new Date(h.time).toLocaleString()}</span>: <span class="font-semibold">${h.delay}ms</span></li>`).join('') + '</ul>' : `<p>${t('proxies.noHistory')}</p>`; const content = `<p><strong>${t('proxies.nodeType')}:</strong> <span class="font-mono px-1.5 py-0.5 bg-[var(--hover-bg)] rounded text-sm">${node.type}</span></p>${historyHtml}`; this.showModal(`${t('proxies.nodeDetails')}: ${nodeName}`, content); },
        async callGeminiAPI(prompt) {
            if (!state.ai.apiKey) {
                const acts = `<a href="#/settings" id="go-to-settings" class="text-white bg-indigo-600 hover:bg-indigo-700 font-semibold rounded-lg text-sm px-5 py-2.5">${t('analyzer.goToSettings')}</a>`;
                this.showModal(t('analyzer.noApiKey'), `<p>${t('analyzer.noApiKeyMsg')}</p>`, acts);
                document.getElementById('go-to-settings').onclick = () => this.hideModal();
                throw new Error('API Key is missing');
            }
            this.showModal(t('analyzer.title'), `<div class="flex items-center justify-center p-8"><div class="w-8 h-8 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin"></div><p class="ml-4">${t('analyzer.loading')}</p></div>`);
            try {
                let apiUrl, payload, headers = { 'Content-Type': 'application/json' };
                if (state.ai.provider === 'gemini') {
                    apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${state.ai.apiKey}`;
                    payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                } else {
                    const baseUrl = state.ai.baseUrl || 'https://api.openai.com/v1';
                    apiUrl = `${baseUrl}/chat/completions`;
                    payload = { model: state.ai.model || "gpt-3.5-turbo", messages: [{ role: "user", content: prompt }] };
                    headers['Authorization'] = `Bearer ${state.ai.apiKey}`;
                }
                const res = await fetch(apiUrl, { method: 'POST', headers, body: JSON.stringify(payload) });
                if (!res.ok) throw new Error(`AI API error ${res.status}: ${await res.text()}`);
                const result = await res.json();
                let analysisText = (state.ai.provider === 'gemini' ? result.candidates?.[0]?.content?.parts?.[0]?.text : result.choices?.[0]?.message?.content) || 'No content in AI response.';
                analysisText = analysisText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/```[\s\S]*?```/g, (match) => `<pre class="bg-gray-100 dark:bg-gray-800 rounded p-4 text-sm">${match.replace(/`/g, '')}</pre>`).replace(/\n\s*-\s/g, '</li><li>').replace(/\n/g, '<br>').replace(/<li>/g, (m, o) => o === 0 ? '<ul><li>' : '<li>').replace(/<br( \/)?>/g, (m, s, o, str) => (str.slice(o-5, o) === '</li>' || str.slice(o-6, o) === '</ul>' ) ? m : '<br>').replace(/<\/li>(\s*)<br(\s*\/)?>/g, '</li>');
                this.showModal(t('analyzer.title'), analysisText);
            } catch (e) {
                console.error('AI analysis failed:', e);
                this.showModal(t('analyzer.error'), `<p>${t('analyzer.errorMsg')}</p><p class="mt-2 text-sm text-red-500">${e.message}</p>`);
            }
        },
        async analyzeConnectionsWithAI() { if (!state.connections.list || state.connections.list.length === 0) { this.showModal(t('analyzer.title'), `<p>${t('analyzer.noConnections')}</p>`); return; } const connData = state.connections.list.slice(0, 50).map(c => `- Host: ${c.metadata.host || c.metadata.destinationIP}, Rule: ${c.rule}, Proxy: ${c.chains.join('->')}`).join('\n'); const prompt = t('analyzer.connectionPrompt') + connData; await this.callGeminiAPI(prompt); },
        async analyzeLogsWithAI() { if (!state.logs.list || state.logs.list.length === 0) { this.showModal(t('analyzer.title'), `<p>${t('analyzer.noLogs')}</p>`); return; } const logData = state.logs.list.slice(0, 100).map(l => `[${l.type}] ${l.payload}`).join('\n'); const prompt = t('analyzer.logPrompt') + logData; await this.callGeminiAPI(prompt); },
        async analyzeProxiesWithAI() { const group = Object.values(state.proxies).find(p => p.name === state.selectedProxyGroup); if (!group || !group.all || group.all.length === 0) { this.showModal(t('analyzer.title'), `<p>${t('analyzer.noProxies')}</p>`); return; } const proxyData = group.all.map(name => { const node = state.proxies[name]; const latHistory = node.history ? `[${node.history.map(h => h.delay).join(', ')}]` : '[]'; return `- Node: ${name}, Type: ${node.type}, Latency History (ms): ${latHistory}`; }).join('\n'); const prompt = t('analyzer.proxyPrompt') + proxyData; await this.callGeminiAPI(prompt); },
        async explainRuleWithAI(type, payload, proxy) { const ruleData = `Type: ${type}, Value: ${payload}, Policy: ${proxy}`; const prompt = t('analyzer.rulePrompt') + ruleData; await this.callGeminiAPI(prompt); },
        confirmCloseConnection(id) { const conn = state.connections.list.find(c => c.id === id); if (!conn) return; const acts = `<button id="modal-cancel-btn" class="font-semibold rounded-lg text-sm px-5 py-2.5 mr-2">${t('common.cancel')}</button><button id="modal-confirm-close-btn" class="text-white bg-red-600 hover:bg-red-700 font-semibold rounded-lg text-sm px-5 py-2.5">${t('common.confirm')}</button>`; this.showModal(t('connections.confirmClose'), `<p>${t('connections.confirmCloseMsg').replace('此连接', `与 <strong>${conn.metadata.host || conn.metadata.destinationIP}</strong> 的连接`)}</p>`, acts); document.getElementById('modal-cancel-btn').onclick = () => this.hideModal(); document.getElementById('modal-confirm-close-btn').onclick = async () => { await this.api('DELETE', `/connections/${id}`); this.hideModal(); }; },
        updateTrafficHistory() { const { up, down } = state.traffic; state.trafficHistory.down.push(down / 1024); state.trafficHistory.down.shift(); state.trafficHistory.up.push(up / 1024); state.trafficHistory.up.shift(); if (trafficChart) { trafficChart.data.datasets[0].data = state.trafficHistory.down; trafficChart.data.datasets[1].data = state.trafficHistory.up; trafficChart.update('none'); } },
        createTrafficChart() { const ctx = document.getElementById('traffic-chart')?.getContext('2d'); if (!ctx) return; trafficChart = new Chart(ctx, { type: 'line', data: { labels: Array(60).fill(''), datasets: [ { label: t('overview.download'), data: state.trafficHistory.down, borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', fill: true, tension: 0.4, borderWidth: 2, pointRadius: 0 }, { label: t('overview.upload'), data: state.trafficHistory.up, borderColor: '#0ea5e9', backgroundColor: 'rgba(14, 165, 233, 0.1)', fill: true, tension: 0.4, borderWidth: 2, pointRadius: 0 } ] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { callback: v => `${v} KB/s`, color: 'var(--text-secondary)' }, grid: { display: false } }, x: { display: false, grid: { display: false } } }, plugins: { legend: { display: false } }, interaction: { intersect: false, mode: 'index' } } }); },
        updateApiStatus(isConnected) { const statusDiv = document.getElementById('api-status'); if(!statusDiv) return; const status = isConnected === undefined ? { text: t('common.connecting'), color: 'amber', icon: 'loader', spin: true } : isConnected ? { text: t('common.connected'), color: 'green', icon: 'check-circle' } : { text: t('common.disconnected'), color: 'red', icon: 'x-circle' }; statusDiv.innerHTML = `<div class="flex items-center text-${status.color}-500"><i data-feather="${status.icon}" class="w-6 h-6 mr-3 ${status.spin ? 'animate-spin' : ''}"></i><span class="font-semibold">${status.text}</span></div>`; feather.replace(); },
        router() { const path = window.location.hash.slice(2) || 'overview'; if (path === state.currentPage && document.getElementById('main-content').hasChildNodes()) return; this.render(); },
        setupGlobalEventListeners() { document.getElementById('menu-btn').onclick = () => document.getElementById('sidebar').classList.toggle('-translate-x-full'); document.getElementById('nav-links').onclick = (e) => { if(e.target.closest('a')) document.getElementById('sidebar').classList.add('-translate-x-full'); }; },
        setLanguage(lang) { state.language = lang; localStorage.setItem('language', lang); document.documentElement.lang = lang; this.updateNav(); this.render(); },
        updateNav() { const navLinks = document.getElementById('nav-links'); const icons = {overview:'layout',proxies:'zap',rules:'list',connections:'globe',logs:'terminal',settings:'settings'}; navLinks.innerHTML = Object.keys(t('nav')).map(key => `<li><a href="#/${key}" class="nav-link flex items-center rounded-r-full mr-4 my-2 p-4 text-[var(--text-secondary)] transition-colors hover:bg-[var(--hover-bg)]"><i data-feather="${icons[key]}" class="w-6 h-6 ml-3"></i><span class="ml-6 whitespace-nowrap text-lg font-semibold">${t(`nav.${key}`)}</span></a></li>`).join(''); document.querySelectorAll('.nav-link').forEach(link => link.classList.toggle('active', link.getAttribute('href') === `#/${state.currentPage}`)); feather.replace(); },
        setTheme(theme) { state.theme = theme; localStorage.setItem('theme', theme); document.documentElement.className = theme; this.updateThemeButtons(); if(trafficChart) { trafficChart.options.scales.y.ticks.color = getComputedStyle(document.body).getPropertyValue('--text-secondary'); trafficChart.options.scales.y.grid.color = getComputedStyle(document.body).getPropertyValue('--border-color'); trafficChart.update(); } },
        updateThemeButtons() { const lightBtn = document.getElementById('theme-light-btn'), darkBtn = document.getElementById('theme-dark-btn'); if(lightBtn && darkBtn) { lightBtn.classList.toggle('bg-indigo-600', state.theme === 'light'); lightBtn.classList.toggle('text-white', state.theme === 'light'); darkBtn.classList.toggle('bg-indigo-600', state.theme === 'dark'); darkBtn.classList.toggle('text-white', state.theme === 'dark'); } }
    };
    
    document.addEventListener('DOMContentLoaded', () => App.init());
</script>
</body>
</html>